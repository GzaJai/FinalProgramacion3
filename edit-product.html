<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon">

  <title>Editar Producto - Timups Admin</title>

  <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
  <link href="css/font-awesome.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />
  <link href="css/responsive.css" rel="stylesheet" />

  <style>
    .form-container {
      max-width: 800px;
      margin: 50px auto;
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }

    .form-container h2 {
      color: #3b4a6b;
      margin-bottom: 30px;
      font-weight: bold;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #3b4a6b;
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b4a6b;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .required {
      color: red;
    }

    .btn-submit {
      background: #3b4a6b;
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
    }

    .btn-submit:hover {
      background: #2c3e50;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      margin-top: 10px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-cancel:hover {
      background: #5a6268;
      color: white;
      text-decoration: none;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .image-preview {
      margin-top: 15px;
    }

    .image-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 5px;
      border: 2px solid #e0e0e0;
    }
  </style>
</head>

<body class="sub_page">

  <header class="header_section">
    <div class="container-fluid">
      <nav class="navbar navbar-expand-lg custom_nav-container">
        <a class="navbar-brand" href="admin-dashboard.html">
          <span>Timups Admin</span>
        </a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="admin-dashboard.html">
                <i class="fa fa-dashboard"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logout-btn">
                <i class="fa fa-sign-out"></i> Cerrar Sesi√≥n
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <section class="contact_section layout_padding">
    <div class="container">
      
      <div id="loading-container" class="loading">
        <i class="fa fa-spinner fa-spin fa-3x"></i>
        <p>Cargando producto...</p>
      </div>

      <div id="form-container" class="form-container" style="display: none;">
        <h2>
          <i class="fa fa-edit"></i> Editar Producto
        </h2>

        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <form id="product-form">
          
          <div class="form-group">
            <label for="name">
              Nombre del Producto <span class="required">*</span>
            </label>
            <input type="text" id="name" name="name" required>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="price">
                  Precio <span class="required">*</span>
                </label>
                <input type="number" id="price" name="price" step="0.01" required min="0">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="stock">
                  Stock <span class="required">*</span>
                </label>
                <input type="number" id="stock" name="stock" required min="0">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="category_id">
              Categor√≠a <span class="required">*</span>
            </label>
            <select id="category_id" name="category_id" required>
              <option value="">Seleccionar categor√≠a...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="description">
              Descripci√≥n
            </label>
            <textarea id="description" name="description"></textarea>
          </div>

          <div class="form-group">
            <label for="image_url">
              URL de Imagen
            </label>
            <input type="url" id="image_url" name="image_url">
            <div class="image-preview" id="image-preview" style="display: none;">
              <img id="preview-img" src="" alt="Vista previa">
            </div>
          </div>

          <div class="form-group">
            <label for="image_public_id">
              ID P√∫blico de Imagen (Cloudinary)
            </label>
            <input type="text" id="image_public_id" name="image_public_id">
          </div>

          <button type="submit" class="btn-submit">
            <i class="fa fa-save"></i> Actualizar Producto
          </button>

          <a href="admin-dashboard.html" class="btn-cancel">
            <i class="fa fa-times"></i> Cancelar
          </a>

        </form>
      </div>
    </div>
  </section>

  <footer class="footer_section">
    <div class="container">
      <div class="footer-info">
        <p>&copy; <span id="displayYear"></span> Timups Admin Panel</p>
      </div>
    </div>
  </footer>

  <script src="js/jquery-3.4.1.min.js"></script>
<script src="js/bootstrap.js"></script>

<script>
  const API_URL = "https://finalprogramacion3-backend-production.up.railway.app/";
  const form = document.getElementById("product-form");
  const errorMessage = document.getElementById("error-message");
  const successMessage = document.getElementById("success-message");
  const imageUrlInput = document.getElementById("image_url");
  const imagePreview = document.getElementById("image-preview");
  const previewImg = document.getElementById("preview-img");
  const loadingContainer = document.getElementById("loading-container");
  const formContainer = document.getElementById("form-container");

  // Obtener ID del producto de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');

  if (!productId) {
    alert("ID de producto no especificado");
    window.location.href = "admin-dashboard.html";
  }

  // Logout
  document.getElementById("logout-btn").addEventListener("click", (e) => {
    e.preventDefault();
    sessionStorage.removeItem("access_token");
    window.location.href = "login.html";
  });

  // üëá AGREGAR ESTA FUNCI√ìN
  async function loadCategories() {
    try {
      const response = await authenticatedFetch(`${API_URL}/categories/`);
      
      if (!response.ok) {
        throw new Error("Error cargando categor√≠as");
      }

      const categories = await response.json();

      console.log(categories);
      
      
      const select = document.getElementById("category_id");
      select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
      
      categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
      });
      
      console.log("‚úÖ Categor√≠as cargadas:", categories);
    } catch (error) {
      console.error("‚ùå Error cargando categor√≠as:", error);
      errorMessage.textContent = "Error al cargar las categor√≠as";
      errorMessage.style.display = "block";
    }
  }

  // Cargar datos del producto
  async function loadProduct() {
    try {
      const response = await authenticatedFetch(`${API_URL}/products/${productId}`);
      
      if (!response.ok) {
        throw new Error("Producto no encontrado");
      }

      const product = await response.json();
      console.log("‚úÖ Producto cargado:", product);

      // Llenar el formulario
      document.getElementById("name").value = product.name || '';
      document.getElementById("price").value = product.price || '';
      document.getElementById("stock").value = product.stock || '';
      document.getElementById("category_id").value = product.category_id || '';
      document.getElementById("description").value = product.description || '';
      document.getElementById("image_url").value = product.image_url || '';
      document.getElementById("image_public_id").value = product.image_public_id || '';

      // Mostrar preview de imagen si existe
      if (product.image_url) {
        previewImg.src = product.image_url;
        imagePreview.style.display = "block";
      }

      loadingContainer.style.display = "none";
      formContainer.style.display = "block";

    } catch (error) {
      console.error("‚ùå Error cargando producto:", error);
      alert("Error al cargar el producto");
      window.location.href = "admin-dashboard.html";
    }
  }

  // Preview de imagen
  imageUrlInput.addEventListener("input", (e) => {
    const url = e.target.value.trim();
    if (url) {
      previewImg.src = url;
      imagePreview.style.display = "block";
      previewImg.onerror = () => {
        imagePreview.style.display = "none";
      };
    } else {
      imagePreview.style.display = "none";
    }
  });

  // Submit form
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    errorMessage.style.display = "none";
    successMessage.style.display = "none";

    const formData = new FormData(form);

    const payload = {
      name: formData.get("name"),
      price: parseFloat(formData.get("price")),
      stock: parseInt(formData.get("stock")),
      category_id: parseInt(formData.get("category_id")),
      image_url: formData.get("image_url") || null,
      image_public_id: formData.get("image_public_id") || null,
      description: formData.get("description") || null
    };

    console.log("üì§ Enviando actualizaci√≥n:", payload);

    try {
      const response = await authenticatedFetch(`${API_URL}/products/${productId}`, {
        method: "PUT",
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Error al actualizar el producto");
      }

      successMessage.textContent = "¬°Producto actualizado exitosamente!";
      successMessage.style.display = "block";

      setTimeout(() => {
        window.location.href = "admin-dashboard.html";
      }, 2000);

    } catch (error) {
      console.error("‚ùå Error:", error);
      errorMessage.textContent = error.message;
      errorMessage.style.display = "block";
      window.scrollTo(0, 0);
    }
  });

  // Funci√≥n helper para peticiones autenticadas
  async function authenticatedFetch(url, options = {}) {
    const token = sessionStorage.getItem("access_token");

    if (!token) {
      throw new Error("No hay token de autenticaci√≥n");
    }

    const defaultHeaders = {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    };

    const config = {
      ...options,
      headers: {
        ...defaultHeaders,
        ...options.headers
      }
    };

    const response = await fetch(url, config);

    if (response.status === 401 || response.status === 403) {
      sessionStorage.removeItem("access_token");
      window.location.href = "login.html";
      throw new Error("No autorizado");
    }

    return response;
  }

  // üëá INICIALIZAR - CARGAR CATEGOR√çAS PRIMERO, LUEGO PRODUCTO
  async function init() {
    try {
      await loadCategories();  // Primero cargar categor√≠as
      await loadProduct();     // Luego cargar producto (para seleccionar la categor√≠a correcta)
    } catch (error) {
      console.error("‚ùå Error en inicializaci√≥n:", error);
    }
  }

  // Ejecutar inicializaci√≥n
  init();
  document.getElementById("displayYear").textContent = new Date().getFullYear();

</script>

</body>

</html>